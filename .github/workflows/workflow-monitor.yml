name: Workflow Monitor

on:
  workflow_run:
    workflows: ["Android Build", "iOS Build", "Quality Checks"]
    types:
      - requested
      - in_progress
      - completed

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
    
    steps:
      - name: Report Workflow Status
        env:
          WORKFLOW_NAME: ${{ github.event.workflow_run.name }}
          WORKFLOW_STATUS: ${{ github.event.workflow_run.status }}
          WORKFLOW_CONCLUSION: ${{ github.event.workflow_run.conclusion }}
          WORKFLOW_URL: ${{ github.event.workflow_run.html_url }}
          WORKFLOW_RUN_ID: ${{ github.event.workflow_run.id }}
          WORKFLOW_ATTEMPT: ${{ github.event.workflow_run.run_attempt }}
          WORKFLOW_BRANCH: ${{ github.event.workflow_run.head_branch }}
          WORKFLOW_COMMIT: ${{ github.event.workflow_run.head_sha }}
          TRIGGERING_ACTOR: ${{ github.event.workflow_run.triggering_actor.login }}
          EVENT_TYPE: ${{ github.event.action }}
        run: |
          echo "=========================================="
          echo "WORKFLOW MONITORING REPORT"
          echo "=========================================="
          echo ""
          echo "ðŸ“Š Event Type: ${EVENT_TYPE}"
          echo "ðŸ“ Workflow: ${WORKFLOW_NAME}"
          echo "ðŸ”— Run URL: ${WORKFLOW_URL}"
          echo "ðŸ”¢ Run ID: ${WORKFLOW_RUN_ID}"
          echo "ðŸ”„ Attempt: ${WORKFLOW_ATTEMPT}"
          echo "ðŸŒ¿ Branch: ${WORKFLOW_BRANCH}"
          echo "ðŸ“ Commit: ${WORKFLOW_COMMIT:0:8}"
          echo "ðŸ‘¤ Triggered by: ${TRIGGERING_ACTOR}"
          echo "â±ï¸  Status: ${WORKFLOW_STATUS}"
          
          if [ "${EVENT_TYPE}" = "completed" ]; then
            echo "âœ… Conclusion: ${WORKFLOW_CONCLUSION}"
            
            # Add emoji based on conclusion
            case "${WORKFLOW_CONCLUSION}" in
              "success")
                echo "ðŸŽ‰ Status: SUCCESS"
                ;;
              "failure")
                echo "âŒ Status: FAILED"
                ;;
              "cancelled")
                echo "ðŸš« Status: CANCELLED"
                ;;
              "skipped")
                echo "â­ï¸  Status: SKIPPED"
                ;;
              *)
                echo "â„¹ï¸  Status: ${WORKFLOW_CONCLUSION}"
                ;;
            esac
          fi
          
          echo ""
          echo "=========================================="

      - name: Get Workflow Timing
        if: github.event.action == 'completed'
        env:
          CREATED_AT: ${{ github.event.workflow_run.created_at }}
          UPDATED_AT: ${{ github.event.workflow_run.updated_at }}
        run: |
          echo "â±ï¸  TIMING INFORMATION"
          echo "Started: ${CREATED_AT}"
          echo "Completed: ${UPDATED_AT}"
          
          # Calculate duration if both timestamps exist
          if [ -n "${CREATED_AT}" ] && [ -n "${UPDATED_AT}" ]; then
            start_epoch=$(date -d "${CREATED_AT}" +%s 2>/dev/null || echo "0")
            end_epoch=$(date -d "${UPDATED_AT}" +%s 2>/dev/null || echo "0")
            
            if [ "${start_epoch}" != "0" ] && [ "${end_epoch}" != "0" ]; then
              duration=$((end_epoch - start_epoch))
              minutes=$((duration / 60))
              seconds=$((duration % 60))
              echo "Duration: ${minutes}m ${seconds}s"
            fi
          fi
          echo ""

      - name: Report Artifacts
        if: github.event.action == 'completed' && github.event.workflow_run.conclusion == 'success'
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.event.workflow_run.id }}
        run: |
          echo "ðŸ“¦ CHECKING FOR ARTIFACTS"
          
          # Use GitHub CLI to list artifacts
          if command -v gh &> /dev/null; then
            artifacts=$(gh api \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/repos/${REPO}/actions/runs/${RUN_ID}/artifacts" \
              --jq '.artifacts[] | "- \(.name) (\(.size_in_bytes) bytes)"' || echo "")
            
            if [ -n "${artifacts}" ]; then
              echo "Found artifacts:"
              echo "${artifacts}"
            else
              echo "No artifacts found for this run."
            fi
          else
            echo "GitHub CLI not available, skipping artifact check."
          fi
          echo ""

      - name: Create Status Summary
        if: github.event.action == 'completed'
        env:
          WORKFLOW_NAME: ${{ github.event.workflow_run.name }}
          WORKFLOW_CONCLUSION: ${{ github.event.workflow_run.conclusion }}
          WORKFLOW_URL: ${{ github.event.workflow_run.html_url }}
          WORKFLOW_BRANCH: ${{ github.event.workflow_run.head_branch }}
          WORKFLOW_COMMIT: ${{ github.event.workflow_run.head_sha }}
        run: |
          # Create a summary that will appear in the GitHub Actions UI
          {
            echo "# Workflow Status Report"
            echo ""
            echo "## ðŸ“Š Overview"
            echo "- **Workflow:** ${WORKFLOW_NAME}"
            echo "- **Branch:** ${WORKFLOW_BRANCH}"
            echo "- **Commit:** \`${WORKFLOW_COMMIT:0:8}\`"
            echo "- **Conclusion:** \`${WORKFLOW_CONCLUSION}\`"
            echo ""
            echo "## ðŸ”— Links"
            echo "- [View Workflow Run](${WORKFLOW_URL})"
            echo ""
            
            # Add conclusion-specific message
            case "${WORKFLOW_CONCLUSION}" in
              "success")
                echo "## âœ… Success"
                echo "The workflow completed successfully!"
                ;;
              "failure")
                echo "## âŒ Failure"
                echo "The workflow failed. Please check the logs."
                ;;
              "cancelled")
                echo "## ðŸš« Cancelled"
                echo "The workflow was cancelled."
                ;;
              *)
                echo "## â„¹ï¸ ${WORKFLOW_CONCLUSION}"
                ;;
            esac
          } >> $GITHUB_STEP_SUMMARY
